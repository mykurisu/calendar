# åˆ©ç”¨lernaç®¡ç†å¤šæ¡†æ¶æ—¥å†ç»„ä»¶

> æœ€è¿‘åœ¨å¼€å‘å…¬å¸å†…éƒ¨ä½¿ç”¨çš„å°ç¨‹åºæ¡†æ¶ï¼Œç¬¬ä¸€æ¬¡æ¥è§¦åˆ°äº†å¤šåŒ…ç®¡ç†å·¥å…· -- [lerna](https://github.com/lerna/lerna/)

æœ¬ç¯‡å°†ä¼šä»¥ä¸ªäººå¼€å‘çš„[æ—¥å†ç»„ä»¶](https://juejin.cn/post/6946154756721115166)ä¸ºä¾‹ï¼Œç®€è¿°ä½¿ç”¨lernaç®¡ç†é¡¹ç›®çš„å†ç¨‹ã€‚

ä¹Ÿè®¸å¤§å®¶ä¼šé—®äº†ï¼Œä½ è¿™æ—¥å†ç»„ä»¶ä¸æ˜¯vueå†™çš„ğŸ´è¦lernaç®¡ç†ä¸ªå•¥ã€‚

![æ—¶ä»£å˜äº†](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95987c4030c244bda407ea1076d1182a~tplv-k3u1fbpfcp-watermark.image)

åœ¨æ„æ€ç»„ä»¶å¼€å‘æ—¶å°±æƒ³ç€èƒ½å¤Ÿä¸ºå¤šæ¡†æ¶çš„ç”¨æˆ·æä¾›æ”¯æŒï¼Œæ‰€ä»¥å°±æœ‰äº†**react/vue/å°ç¨‹åº**ç‰ˆæœ¬ã€‚

## åˆæ¢lerna

å›åˆ°æ­£é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€çœ‹é¡¹ç›®çš„ç›®å½•ç»“æ„ã€‚

![WX20210618-205140@2x.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c517857c5fc447369f340b13ccc00f17~tplv-k3u1fbpfcp-watermark.image)

æŒ‰ç…§lernaé¡¹ç›®é»˜è®¤çš„é¡¹ç›®ç»“æ„ï¼Œæˆ‘ä»¬ä¼šå°†éœ€è¦ç®¡ç†çš„åŒ…éƒ½æ”¾è¿›`packages`æ–‡ä»¶å¤¹å†…ï¼Œå¹¶åœ¨æ ¹ç›®å½•çš„`lerna.json`ä¸­ç¼–å†™lernaç›¸å…³çš„é…ç½®ã€‚

![WX20210618-205226@2x.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79a9c5b6d86643c88328b64b205ec6e8~tplv-k3u1fbpfcp-watermark.image)

`packages`æ–‡ä»¶å¤¹å†…çš„ç»“æ„å¦‚ä¸Šå›¾ï¼Œä»£è¡¨æˆ‘ä½¿ç”¨lernaåŒæ—¶åœ¨ç®¡ç†4ä¸ªåŒ…ï¼Œåˆ†åˆ«åŸºäºvue/react/åŸç”Ÿå¾®ä¿¡å°ç¨‹åºå¼€å‘è€Œæˆçš„æ—¥å†ç»„ä»¶ï¼Œä»¥åŠè´Ÿè´£å¤„ç†æ—¥å†æ ¸å¿ƒé€»è¾‘çš„`core`åŒ…ã€‚

[æ—¥å†ç»„ä»¶](https://juejin.cn/post/6946154756721115166)æ–‡ä¸­æœ‰æåŠï¼Œç¬”è€…å¯¹ä¸€ä¸ªä¸Šå¤æ—¶æœŸçš„æ—¥å†ç»„ä»¶åšäº†ä¸€æ¬¡ä¼˜åŒ–ï¼Œä¼˜åŒ–çš„é‡ç‚¹æ˜¯**æŠ½ç¦»**åŠ**æ˜“è¯»**ã€‚

åœ¨æŠ½ç¦»çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œå…¶å®**ç”Ÿæˆæ—¥å†æ•°æ®**è¿™ä»¶äº‹ï¼Œä¸è®ºè¿™ä¸ªç»„ä»¶æ˜¯vueå¼€å‘çš„è¿˜æ˜¯reactå¼€å‘ç”šè‡³æ˜¯å°ç¨‹åºç»„ä»¶ï¼Œéƒ½éœ€è¦è¿™æ®µé€»è¾‘ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶è¿›è¡Œæ›´å½»åº•çš„æŠ½ç¦»ï¼Œç›´æ¥å°†è¿™ç±»é€»è¾‘æ”¶æŸæˆä¾èµ–åŒ…ï¼Œä¾›æ‰€æœ‰ç±»å‹çš„æ—¥å†ç»„ä»¶è¿›è¡Œè°ƒç”¨ã€‚

æ ¸å¿ƒé€»è¾‘å…·ä½“å®ç°å°±ä¸å†èµ˜è¿°äº†ï¼ŒåŸºæœ¬å’Œå‰ä¸€ç¯‡æ–‡ç« é˜è¿°çš„ä¸€è‡´ã€‚å…³äºæ—¥å†è§†å›¾å±‚reactä»¥åŠå°ç¨‹åºçš„å®ç°ï¼ŒåŸºæœ¬å°±æ˜¯å°†Vueä¸­çš„å®ç°â€œç¿»è¯‘â€æˆæ¡†æ¶å¯¹åº”çš„å†™æ³•ã€‚å¦‚æœå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„ä¼ é€é—¨â†“â†“

### Reactç»„ä»¶å®ç°[(Githubä¼ é€é—¨)](https://github.com/mykurisu/calendar/tree/master-next/packages/react)

åœ¨Reactå®è·µä¸­ï¼Œæ¯”è¾ƒç‰¹åˆ«çš„æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼š

- ç”¨useMemoæ›¿ä»£vueå®ç°ä¸­çš„computed

```javascript
const isFirstMonth = useMemo(() => selectedMonth === 0);

const isLastMonth = useMemo(() => selectedMonth === 11);
```

- ç”¨useLayoutEffectæ›¿ä»£vueå®ç°ä¸­çš„nextTick

```javascript

useLayoutEffect(() => {

    setBlockHeight(document.querySelector('.__main__block-head').offsetWidth + "px");

}, [calendarData]);

```

### å¾®ä¿¡å°ç¨‹åºç»„ä»¶å®ç°[(Githubä¼ é€é—¨)](https://github.com/mykurisu/calendar/tree/master-next/packages/miniapp)

å°ç¨‹åºæœ¬èº«çš„å¼€å‘æ¨¡å¼å°±å’Œvueè°œä¹‹ç›¸ä¼¼ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜¯æ— ç—›ç§»æ¤ï¼Œå°±æ˜¯åœ¨è·å–æ—¥å†æ–¹å—å®½åº¦çš„æ—¶å€™æ²¡æ³•ç”¨`querySelector`ï¼Œå¿…é¡»å¾—ä½¿ç”¨å°ç¨‹åºè‡ªå·±çš„API`createSelectorQuery`ã€‚

ä½†æ˜¯åœ¨æ ·å¼è¿™å—å°±ä¸å¤ªä¸€æ ·ï¼Œå¾®ä¿¡å°ç¨‹åºåªè®¤ä¸wxmlåŒåçš„wxssæ–‡ä»¶ï¼Œä¸æ”¯æŒæ ·å¼çš„å¯¼å…¥ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œæ ¸å¿ƒé€»è¾‘æ‰“åŒ…çš„æ—¶å€™åŒæ—¶æ‰§è¡Œä¸€ä¸ª`miniapp-script.js`ï¼Œå°†cssæ–‡ä»¶å¤åˆ¶åˆ°miniappç›®å½•ä¸­å¹¶æ›´æ”¹å…¶åç¼€åã€‚

## lernaå®è·µ

ç»“åˆä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬åªèƒ½è®¤ä¸ºlernaæ˜¯ä¸€ç§åŒ…ç®¡ç†çš„æ€ç»´ï¼Œå°†åŸæ¥çš„å•é¡¹ç›®å¯¹å•ä¾èµ–åŒ…çš„æ¨¡å¼å˜æˆäº†å•é¡¹ç›®å¯¹å¤šä¾èµ–åŒ…ï¼Œå¹¶çœ‹ä¸å‡ºå®ƒæœ‰ä»€ä¹ˆå…¶ä»–å®è´¨æ€§çš„å¸®åŠ©ã€‚

ä½†æ˜¯å½“æˆ‘å‡†å¤‡å°†å†™å¥½çš„4ä¸ªä¾èµ–åŒ…å‘å¸ƒåˆ°npmæ—¶ï¼Œé‡åˆ°äº†æ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œè¿™4ä¸ªä¾èµ–çš„æ‰“åŒ…æ–¹å¼å®Œå…¨ä¸åŒï¼Œå‘å¸ƒçš„æ—¶å€™å²‚ä¸æ˜¯å¾—cdåˆ°æ¯ä¸ªåŒ…é‡Œè¿›è¡Œinstallã€buildã€versionç­‰æœºæ¢°å¼çš„æ“ä½œã€‚ï¼ˆå…¶å®å¹¶ä¸ç”¨ï¼‰

é¦–å…ˆï¼Œå…ˆçœ‹çœ‹åˆ›å»ºlernaé¡¹ç›®çš„ç¬¬ä¸€æ­¥ï¼Œ`lerna.json`çš„é…ç½®ã€‚

```json
{

    "version": "independent",

    "packages": [

        "packages/*"

    ],

    "npmClient": "yarn",

    "useWorkspaces": true,

    "command": {

        "publish": {

            "allowBranch": "master-next"

        }

    }

}
```

`version`å­—æ®µæ˜¯ç”¨æ¥å®šä¹‰lernaé¡¹ç›®çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœæ­¤å­—æ®µå£°æ˜äº†ç‰ˆæœ¬å·ï¼Œåˆ™å†…éƒ¨çš„æ‰€æœ‰å­é¡¹ç›®éƒ½ä¼šæŒ‰æ­¤ç‰ˆæœ¬å·è¿›è¡Œå‘å¸ƒã€‚ä½†æ˜¯å¯ä»¥é€‰æ‹©é€šè¿‡ä¸å¡«ç‰ˆæœ¬å·ï¼Œå¦‚ä¸Šè¿°é…ç½®ä¸€æ ·å¡«å†™`independent`ï¼Œæ¥è¿›è¡Œå¦ä¸€ç§å‘å¸ƒæ¨¡å¼ï¼Œåœ¨è¿™ç§å‘å¸ƒæ¨¡å¼ä¸‹æ¯ä¸ªå­é¡¹ç›®ç»´æŠ¤è‡ªå·±çš„ç‰ˆæœ¬å·ã€‚

`packages`å­—æ®µåˆ™æ˜¯ç”¨äºå£°æ˜ä½œç”¨ç›®å½•ï¼Œåªæœ‰åœ¨æ•°ç»„å†…çš„å­é¡¹ç›®æ‰ä¼šè¢«lernaæ£€ç´¢åˆ°ã€‚

`npmClient`å­—æ®µç”¨äºå£°æ˜lernaæ‰§è¡ŒæŒ‡ä»¤æ—¶ä½¿ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œé»˜è®¤æ˜¯`npm`ã€‚é…ç½®é‡Œå£°æ˜çš„æ˜¯`yarn`ï¼Œæ‰€ä»¥å¯ä»¥å¼€å¯`workspaces`æ¨¡å¼ã€‚workspacesæ˜¯yarnçš„ä¸€å¤§ç‰¹è‰²ï¼Œä½¿ç”¨äº†workspacesä¹‹åç»å¤§å¤šæ•°çš„ä¾èµ–åŒ…éƒ½è¢«æå‡åˆ°äº†æ ¹ç›®å½•ä¸‹çš„node_modulesä¹‹å†…ï¼Œå„ä¸ªå­é¡¹ç›®çš„node_modulesé‡Œé¢ä¸ä¼šé‡å¤å­˜åœ¨ä¾èµ–ã€‚

`command`å­—æ®µåˆ™æ˜¯å¯¹lernaæŒ‡ä»¤å†…ç½®çš„å‚æ•°è¿›è¡Œæ”¹åŠ¨ã€‚[å…·ä½“ç”¨æ³•](https://github.com/lerna/lerna#lernajson)

æ¥ä¸‹æ¥ï¼Œç¬”è€…é€šè¿‡ä¸€æ¬¡æ—¥å†ç»„ä»¶çš„æ‰“åŒ…å‘å¸ƒå…¨æµç¨‹ï¼Œç»™å¤§å®¶ç›´è§‚çš„å±•ç¤ºæ¥å…¥lernaä¹‹åçš„ç©æ³•ã€‚

> lerna ls
>
> è·å–æœ¬åœ°é¡¹ç›®å†…å­é¡¹ç›®åˆ—è¡¨

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8a48605c1674f8283ba1b1678368b5f~tplv-k3u1fbpfcp-watermark.image)

> lerna bootstrap
>
> å®‰è£…ä½œç”¨ç›®å½•ä¸‹å…¨é¡¹ç›®çš„ä¾èµ–

> lerna changed or lerna diff
>
> ç”¨äºç¡®è®¤æœ¬æ¬¡ä¿®æ”¹æ¶‰åŠåˆ°çš„èŒƒå›´ï¼Œlernaä¼šå°†æœ‰æ”¹åŠ¨çš„å­é¡¹ç›®éƒ½åˆ—å‡ºæ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬åŠæ—¶å›é¡¾æ”¹åŠ¨

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2989ac4b9f2043998eb715180f3107a8~tplv-k3u1fbpfcp-watermark.image)

> lerna run (any script)
>
> åœ¨æ‰€æœ‰å­é¡¹ç›®ä¾æ¬¡æ‰§è¡ŒæŸæ¡æŒ‡ä»¤ï¼Œå›¾ä¸­å±•ç¤ºçš„æ˜¯buildæŒ‡ä»¤ï¼Œç­‰åŒäºåœ¨æ¯ä¸ªå­é¡¹ç›®ä¸­è¿›è¡Œäº†yarn build

![WX20210811-112000@2x.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f9fcf109835416c9c6bb3de86f52db6~tplv-k3u1fbpfcp-watermark.image)

> lerna publish
>
> å°†æœ¬æ¬¡æ”¹åŠ¨çš„å­é¡¹ç›®æ‰¹é‡è¿›è¡Œnpmå‘å¸ƒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨è¾“å…¥æŒ‡ä»¤ä¹‹åå¯ä»¥ä¸ºæ¯ä¸ªé¡¹ç›®æŒ‡å®šæƒ³è¦å‘å¸ƒçš„ç‰ˆæœ¬

![WX20210811-112236@2x.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c70ec8b5413848e3b7cd80684370fb08~tplv-k3u1fbpfcp-watermark.image)

![WX20210811-112254@2x.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2d8c7a5dedb42cda40bb65537ab2b5d~tplv-k3u1fbpfcp-watermark.image)

![WX20210811-112329@2x.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2be216f970b847f2829690c4cf682e2b~tplv-k3u1fbpfcp-watermark.image)

> lerna clean
>
> åç»­è¿­ä»£æ—¶å¦‚æœæƒ³é‡æ–°å®‰è£…å„é¡¹ç›®ä¾èµ–ï¼Œå¯ä»¥å…ˆæ‰§è¡ŒcleanæŒ‡ä»¤ï¼Œå®ƒä¼šå°†é¡¹ç›®åº•ä¸‹æ‰€æœ‰node_moduleséƒ½æ¸…ç†å¹²å‡€

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c631a8a26ee44979a89865bec56053c3~tplv-k3u1fbpfcp-watermark.image)

## é—²èŠ

å†æ—¶2å¹´çš„æ—¥å†ç»„ä»¶ï¼Œæ€»ç®—æœ‰äº†å¤§æ¦‚é›å½¢ï¼Œæ¯ä¸ªæ¡†æ¶éƒ½æœ‰å¼€ç®±å³ç”¨çš„npmåŒ…ï¼š

[@mykurisu/calendar-component-vue](https://www.npmjs.com/package/@mykurisu/calendar-component-vue)

[@mykurisu/calendar-component-miniapp](https://www.npmjs.com/package/@mykurisu/calendar-component-miniapp)

[@mykurisu/calendar-component-react](https://www.npmjs.com/package/@mykurisu/calendar-component-react)

å¦‚æœå¤§å®¶æœ‰éœ€è¦çš„è¯å¯ä»¥ç›´æ¥installï¼Œæœ‰ä»»ä½•é—®é¢˜éƒ½å¯ä»¥åˆ°[@mykurisu/calendar](https://github.com/mykurisu/calendar)ä¸­è¿›è¡Œåé¦ˆã€‚

å¦‚æœæ˜¯å…³äºæ ·å¼ä¸Šçš„é—®é¢˜ï¼Œæˆ‘å»ºè®®forkä¸€ä¸‹é¡¹ç›®ï¼Œç›´æ¥ä¿®æ”¹coreä¸­çš„æ ·å¼ï¼Œä¿®æ”¹å®Œä¹‹åæ”¹ä¸€ä¸‹package.jsoné‡Œé¢çš„é…ç½®ï¼Œç”šè‡³å¯ä»¥å‘å¸ƒæˆè‡ªå·±çš„ç§æœ‰åŒ…ã€‚å¦å¤–ï¼Œå¦‚æœæœ‰æ—¶é—´çš„è¯æˆ‘ä¹Ÿä¼šæ›´æ–°å¤šä¸ªæ—¥å†çš®è‚¤ï¼Œäº‰å–åšåˆ°çœŸæ­£çš„å¼€ç®±å³ç”¨ã€‚

æœ€åï¼Œå¦‚æœæœ¬é¡¹ç›®å¯¹å¤§å®¶æœ‰å¸®åŠ©éº»çƒ¦å¸®å¿™ç‚¹ç‚¹[@mykurisu/calendar](https://github.com/mykurisu/calendar)çš„starï¼Œåç»­çš„æ›´æ–°ä¹Ÿä¼šåŠæ—¶æ¨é€ç»™å¤§å®¶ã€‚